# User Management System

This project implements a user management system with features for secure login and registration. It includes password hashing, JWT-based authentication, and role-based access control to ensure data security and controlled access to resources and routes.

## Table of Contents

- [User Roles](#user-roles)
- [Login and Registration Implementation](#login-and-registration-implementation)
  - [Registration Process](#registration-process)
  - [Login Process](#login-process)
- [Access Control](#access-control)
- [Code Examples](#code-examples)

## User Roles

The system currently supports two primary user roles:

1. **Employee**: Standard users with access to basic features in the application.
2. **Manager**: Users with additional privileges, allowing access to management features.

Each user has a unique `EmployeeId` for identification, used during login along with their password. Roles are assigned dynamically based on the user's record in the database.

---

## Login and Registration Implementation

### Registration Process

Registration of new users is done by a user with a Role - Manager. Upon registration, basic information is provided including `Name`, `EmployeeId`, `Password`, and `Role`. The password is securely hashed using bcrypt before being stored in the database.

#### Code Example
- **Controller:**

```csharp
[HttpPost("register")]
public async Task<IActionResult> PostPerson([FromBody] IPerson person)
{        
    var result = await _peopleService.PostPerson(person);
        
    if (result == "Success")
    {
        return Ok("User registered successfully.");
    }

    return BadRequest(result);
}
```

- **Service:**

```csharp
public async Task<string> PostPerson(IPerson person) {
  try {
    // Ensure the password is hashed
    person.Password = BCrypt.Net.BCrypt.HashPassword(person.Password);

    // Read the existing people data from the database
    var peopleArray = await _databaseService.ReadDBAsync();

    // Check if a person with the same EmployeeId exists and is inactive
    var existingPerson = peopleArray.FirstOrDefault(
        p => p["EmployeeId"]?.Value<string>() == person.EmployeeId.ToString());

    if (existingPerson != null) {
      if (existingPerson["IsActive"]?.Value<bool>() == false) {
        // Reactivate the existing person by setting IsActive to true
        existingPerson["IsActive"] = true;
        existingPerson["Password"] =
            person.Password;  // Update password if needed
        existingPerson["ModifiedOn"] = DateTime.Now;
      } else {
        // If the person is active, throw an exception
        throw new Exception("Employee ID already exists and is active.");
      }
    } else {
      // Add new person if no record with the EmployeeId exists
      var newPerson = JObject.FromObject(person);
      newPerson["CreatedOn"] = DateTime.Now;
      peopleArray.Add(newPerson);
    }

    // Write the updated data back to the database
    await _databaseService.WriteDBAsync(peopleArray);
    return "Success";
  } catch (Exception ex) {
    Console.WriteLine($"Error in PostPerson: {ex.Message}");
    return ex.Message;
  }
}
```
### Login

For login, users authenticate by submitting their EmployeeId and Password. If successful, a JWT token is generated and returned. This token can then be used to access protected resources/routes.
#### Code Example
- **Controller:**

```csharp
[HttpPost("login")]
public async Task<IActionResult> Login([FromBody] IPerson person)
{
    var people = await _peopleService.GetPeople(employeeId: person.EmployeeId, active: "true");
    var foundPerson = people.FirstOrDefault();

    if (foundPerson == null)
    {
        return Unauthorized("Invalid employee ID or inactive account.");
    }

    bool isPasswordValid = BCrypt.Net.BCrypt.Verify(person.Password, foundPerson.Password);
    if (!isPasswordValid)
    {
        return Unauthorized("Invalid password.");
    }

    var securityKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_config["Jwt:Key"]));
    var credentials = new SigningCredentials(securityKey, SecurityAlgorithms.HmacSha256);

    var token = new JwtSecurityToken(
        _config["Jwt:Issuer"],
        _config["Jwt:Issuer"],
        null,
        expires: DateTime.Now.AddMinutes(120),
        signingCredentials: credentials);

    var jwtToken = new JwtSecurityTokenHandler().WriteToken(token);

    // Add Role to the response
    var response = new { Token = jwtToken, EmployeeId = foundPerson.EmployeeId, Role = foundPerson.Role };

    return Ok(response);
}
```
- **Service:**

```csharp
public async Task<List<PersonBase>> GetPeople(string? role = null,
                                              string? active = null,
                                              string? employeeId = null) {
  try {
    var peopleArray = await _databaseService.ReadDBAsync();

    // Apply all filters
    peopleArray = new JArray(peopleArray.Where(
        p => (role == null || p["Role"]?.Value<string>() == role) &&
             (active == null ||
              p["IsActive"]?.Value<bool>() == bool.Parse(active)) &&
             (employeeId == null ||
              p["EmployeeId"]?.Value<string>() == employeeId)));

    var peopleList = JsonConvert.DeserializeObject<List<PersonBase>>(
        peopleArray.ToString(), settings);
    return peopleList!;
  } catch (Exception ex) {
    Console.WriteLine($"Error in GetPeople: {ex.Message}");
    return new List<PersonBase>();
  }
}
```

### Blazor Login Page

In the Blazor front end, the login page handles user authentication, stores the JWT token in local storage, and redirects the user to the dashboard upon successful login.

#### Code Example

```razor
@page "/login"
@layout Layout.EmptyLayout
@inject IHttpClientFactory ClientFactory
@inject ILocalStorageService LocalStorage
@inject NavigationManager NavigationManager

<div class="d-flex justify-content-center align-items-center vh-100">
    <div class="p-4" style="width: 100%; max-width: 400px;">

        <div style="display: flex; justify-content: center;">
            <img src="images/salling-group-logo.png" alt="Salling Group Logo">
        </div>
        
        <h2 class="text-center mb-4">Login</h2>

        <EditForm Model="@loginModel" OnValidSubmit="@HandleLogin" FormName="loginForm">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-group">
                <label for="employeeId">Employee ID</label>
                <InputText id="employeeId" class="form-control" @bind-Value="loginModel.EmployeeId" placeholder="(e.g. 123456)" style="font-size: 18px;" />
            </div>

            <div class="form-group mt-3">
                <label for="password">Password</label>
                <InputText id="password" class="form-control" type="password" @bind-Value="loginModel.Password" placeholder="(e.g. 1234)" style="font-size: 18px;" />
            </div>

            <button type="submit" class="btn btn-primary w-100 mt-4" style="font-size: 20px;">Login</button>
        </EditForm>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private PersonBase loginModel { get; set; } = new PersonBase();

    private async Task HandleLogin()
    {
        try
        {
            var client = ClientFactory.CreateClient("BackendAPI");
            var response = await client.PostAsJsonAsync("api/People/login", loginModel);

            if (response.IsSuccessStatusCode)
            {
                var responseData = await response.Content.ReadFromJsonAsync<Dictionary<string, string>>();
                if (responseData != null &&
                    responseData.TryGetValue("token", out var token) &&
                    responseData.TryGetValue("employeeId", out var employeeId) &&
                    responseData.TryGetValue("role", out var role)) // Retrieve role from response
                {                    
                    await LocalStorage.SetItemAsync("authToken", token);
                    await LocalStorage.SetItemAsync("employeeId", employeeId);
                    await LocalStorage.SetItemAsync("userRole", role); // Store role in local storage

                    Console.WriteLine("Login successful. Token and Role stored.");
                    
                    // Redirect to the employee's dashboard
                    NavigationManager.NavigateTo($"/dashboard");
                }
                else
                {
                    Console.WriteLine("Login succeeded but token, employeeId, or role was not received.");
                }
            }
            else
            {
                Console.WriteLine("Login failed");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }
}
```

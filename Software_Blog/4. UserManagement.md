# User Management System

This project implements a user management system with features for secure login and registration. It includes password hashing, JWT-based authentication, and role-based access control to ensure data security and controlled access to resources and routes.

---

## Table of Contents

- [User Roles](#user-roles)
- [Login and Registration Implementation](#login-and-registration-implementation)
  - [Registration Process](#registration-process)
  - [Login Process](#login-process)
- [Access Control](#access-control)
- [Code Examples](#code-examples)

---

## User Roles

The system currently supports two primary user roles:

1. **Employee**: Standard users with access to basic features in the application.
2. **Manager**: Users with additional privileges, allowing access to management features.

Each user has a unique `EmployeeId` for identification, used during login along with their password. Roles are assigned dynamically based on the user's record in the database.

---

## Login and Registration Implementation

### Registration Process

Upon registration, users provide basic information including `Name`, `EmployeeId`, `Password`, and `Role`. The password is securely hashed using bcrypt before being stored in the database. If registration is successful, a JWT token is generated and returned.

#### Code Example

```csharp
[HttpPost]
public async Task<IActionResult> PostPerson([FromBody] IPerson person)
{
    // Hash the password before storing it
    person.Password = BCrypt.Net.BCrypt.HashPassword(person.Password);
    
    var result = await _peopleService.PostPerson(person);
    
    if (result == "Success")
    {
        // Generate JWT token upon successful registration
        var token = GenerateJwtToken(person.EmployeeId);
        return Ok(new { Token = token });
    }

    return BadRequest(result);
}
```

### Login

For login, users authenticate by submitting their EmployeeId and Password. If successful, a JWT token is generated and returned. This token can then be used to access protected resources/routes.
#### Code Example

```csharp
[HttpPost("login")]
public async Task<IActionResult> Login([FromBody] IPerson person)
{
    var people = await _peopleService.GetPeople(employeeId: person.EmployeeId, active: "true");
    var foundPerson = people.FirstOrDefault();

    if (foundPerson == null)
    {
        return Unauthorized("Invalid employee ID or inactive account.");
    }

    // Verify the password
    bool isPasswordValid = BCrypt.Net.BCrypt.Verify(person.Password, foundPerson.Password);
    
    if (!isPasswordValid)
    {
        return Unauthorized("Invalid password.");
    }

    // Generate JWT token
    var token = GenerateJwtToken(person.EmployeeId);
    return Ok(new { Token = token });
}
```

### Blazor Login Page

In the Blazor front end, the login page handles user authentication, stores the JWT token in local storage, and redirects the user to the dashboard upon successful login.

#### Code Example

```razor
@page "/login"
@layout Layout.EmptyLayout
@inject IHttpClientFactory ClientFactory
@inject ILocalStorageService LocalStorage
@inject NavigationManager NavigationManager

<h2>Login</h2>

<EditForm Model="@loginModel" OnValidSubmit="@HandleLogin" FormName="loginForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group">
        <label for="employeeId">Employee ID</label>
        <InputText id="employeeId" class="form-control" @bind-Value="loginModel.EmployeeId" />
    </div>

    <div class="form-group">
        <label for="password">Password</label>
        <InputText id="password" class="form-control" type="password" @bind-Value="loginModel.Password" />
    </div>

    <button type="submit" class="btn btn-primary">Login</button>
</EditForm>

@code {
    [SupplyParameterFromForm]
    private PersonBase loginModel { get; set; } = new PersonBase();

    private async Task HandleLogin()
    {
        try
        {
            var client = ClientFactory.CreateClient("BackendAPI");
            // Send the login data to the backend API
            var response = await client.PostAsJsonAsync("api/People/login", loginModel);

            if (response.IsSuccessStatusCode)
            {
                // Retrieve the token from the response
                var responseData = await response.Content.ReadFromJsonAsync<Dictionary<string, string>>();
                foreach (var kvp in responseData)
                {
                    Console.WriteLine($"Login: Key: {kvp.Key}, Value: {kvp.Value}");
                }
                if (responseData != null && responseData.TryGetValue("token", out var token))
                {
                    Console.WriteLine("Login successful. Token stored.");
                    
                    // Store the token in local storage
                    await LocalStorage.SetItemAsync("authToken", token);
                    
                    // Redirect to the dashboard
                    NavigationManager.NavigateTo("/dashboard");
                }
                else
                {
                    Console.WriteLine("Login succeeded but token was not received.");
                }
            }
            else
            {
                Console.WriteLine("Login failed");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }
}
```
